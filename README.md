Controller
=====
## Инсталяция:
* один раз выполнить настройки Linux указанный по ссылке https://github.com/f0-soft/wiki/wiki/Npm-install-from-private-github
* запустить команду: npm install git+ssh://git@github.com:f0-soft/controller.git
* контроллер будет находится в node_modules/f0.controller

## Тестирование:
* включить mock view и flexo (изменить в файле config/config.js значения объекта mock на {flexo:true, view:true}, для отключения необходимо эти значения поменять на false)
* включить mock rabbit (изменить в файле config/flexoConfig.js значения объекта mock на true, для отключения поменять на false)
* запустить test.js
!!! Для случая когда view содержит две flexo схемы: тест c mock работает только с указанными схемами в тесте (ограничение mock)

## Подключение:
var Controller = require('controller');

## init( config, callback )
Запускает инициализацию контроллера:
* создание клиента redis
* сохранение ссылки на инициализированную view или на её mock
* сохранение ссылки на объект с данными из схем flexo коллекций
* сохранение ссылки на объект с данными схемы меню
* сохранение ссылки на объект с данными схемы form

Параметры:
* config - объект с параметрами
    * [redisConfig] — объект хранящий в себе параметры подключения к Redis
        * config.port — число, порт Redis
        * config.host — строка, хост Redis
        * [config.max_attempts] — число, количество попыток подключения
    * view - ccылка на конструктор view
    * flexoSchemes - объект с описанием flexo схем в виде {nameFlexoScheme:{read:[], modify:[]}}
    * menuConfig - объект со схемой меню
    * formConfig - объект со схемой формы
* callback (err) — функция обратного вызова
    * err — ошибка подключения к Redis от node_redis


## Controller.create()
Конструктор контроллера.

## find( query, callback )
Читает запрашиваемые права или данные пользователя, а именно:
* проверяется наличие необходимых параметров в запросе для поиска
* при поиске прав:
    * создается модель прав и осуществляется поиск объекта прав
* при поиске данных о пользователе:
    * просто запрос по id или логину возвращаются кеш с данными из redis
    * сложные запросы на поиск обрабатываются в mongo с использованием flexo коллекции и redis для получения паролей, если такое поле указано в options.fields

Параметры:
* query - объект запрос
    * [user] - объект содержащий параметры поиска пользователя
        * [login]/[_id] - строка, логин пользователя или идентификатор пользователя для организациия простого поиска пользователя из redis
        * [query] - объект сложного запроса
            * [selectors] - объект поисковый запрос Mongo
            * [options] - объект с дополнительными параметрами
                * [limit] - число, ограничение количества результатов поиска
                * [skip] - число, смещение ограничения количества результатов поиска
                * [sort] - объект или массив объектов sort, правило сортировки Mongo
                * [hint] - объект, содержит указание по выбору индекса Mongo
        * [options] - параметры для организации сложного поиска
            * [count] - логическое, опция запроса количества документов удовлетворяющих запросу
            * [all] - логическое, возврат всех документов без учета ранее переданных ( прозрачный запрос )
            * [nocache] - логическое, предотвращает сохранение учет документов как ранее переданных
            * [fields] - массив, содержит названия полей, с которыми надо вернуть документы
    * [access] - объект содержащий параметры поиска прав доступа
        * [flexoSchemeName]/[viewName]/[menuName] - строка, название flexo схемы или view, или меню
        * [role]/[login] - строка, роль или логин пользователя искомого объекта прав
* callback(err, reply) — функция обратного вызова
    * err - ...
    * reply - возвращается объект с информацией о пользователе, или запрашиваемые объект прав, при сложном запросе данных о пользователе возвращается массив объектов

## delete( query, callback )
Удаляем пользователя или объект прав
* проверяется наличие необходимых параметров в запросе для удаления
* при удалении прав:
    * создается модель прав и осуществляется её удаление
* при удалении пользователя:
    * создается модель пользователя
    * осуществляется удаление из mongo с использованием flexo коллекции
    * осуществляется удаление из redis

Параметры:
* query - объект запрос
    * [user] - объект содержащий параметры удаления пользователя
        * [query] - объект запрос на удаление пользователя
            * selector - объект содержащий _id удаляемого пользователя
    * [access] - объект содержащий параметры удаления прав доступа
        * [flexoSchemeName]/[viewName] - строка, название flexo схемы или view
        * [role]/[login] - строка, роль удаляемого объекта прав или логин пользователя
* callback(err, reply) — функция обратного вызова
    * err - ...
    * reply - возвращается логическое true при успешном выполнении операции, при удалении пользователя возвращается _id удаленного пользователя

## create( query, callback )
Создаем пользователя или объект прав
* проверяется наличие неоходимых параметров в запросе для создания
* при создании объекта прав:
    * создается модель прав, наполняем её пришедшими данными и сохраняем в redis
* при создании пользователя:
    * создается модель пользователя
    * проверяется уникальность создаваемого пользователя
    * сохраняются данные (без пароля) в mongo с использованием flexo коллекции
    * сохраняются данные в redis

Параметры:
* query - объект запрос
    * [user] - объект содержащий параметры создания пользователя в виде {fieldName:value}
    * [access] - объект содержащий параметры создания прав доступа
        * [flexoSchemeName]/[viewName]/[menuName] - строка, название flexo схемы или view, или меню
        * [role]/[login] - строка, роль или логин пользователя создаваемого объекта прав
        * objAccess - объект с описание прав доступа
* callback(err, reply) — функция обратного вызова
    * err - ...
    * reply - возвращается логическое true при успешном выполнении операции, при создании пользователя возвращается _id созданного пользователя

## modify( query, callback )
Модификация данных пользователя или объекта прав
* проверяется наличие необходимых параметров в запросе для модификации
* при модификации объекта прав:
    * тоже что и при create (создается модель прав, наполняем её пришедшими данными и сохраняем в redis)
* при модификации пользователя:
    * осуществляется изменения в mongo посредством view
    * создается модель пользователя
    * считывается предыдущуй кеш из redis с данными о пользователе
    * вносятся изменения в кеш не затрагивая поле _id
    * сохраняется измененный кеш в redis

Параметры:
* query - объект запрос
    * [user] - объект запрос на изменение данных о пользователе
        * [query] - объект запрос
            * [selector] - объект содержащий _id пользователя
            * [properties] - объект содержащий только измененные данные о пользователе в виде {fieldName:value}
    * [access] - объект содержащий параметры модификации прав доступа
        * [flexoSchemeName]/[viewName] - строка, название flexo схемы или view
        * [role]/[login] - строка, роль или логин пользователя модифицируемого объекта прав
        * objAccess - объект с описание прав доступа
* callback(err, reply) — функция обратного вызова
    * err - ...
    * reply - возвращается логическое true при успешном выполнении операции, при модификации пользователя возвращается _id пользователя

## getTemplate ( type, name, user, role, socket, callback )
Обрабатываем запрос на получение шаблона view:
* для получения шаблона меню:
    * формируется модель меню
    * ...
* для получения шаблона view:
    * создаем модели прав на view по роли и по пользователю определяем пересечение прав
    * создаем модели прав по роли и по пользователю на flexo схемы входящие во view и находим их пересечения
    * создаем flexo коллекции входящие во view c максимальными параметрами на чтение при их наличии
    * прикрепляем все данные о правах к view и созданные flexo коллекции к socket
    * передаем необходимые данные во view

Параметры:
* type - строка, определяющая тип запроса на шаблон view ('view'), или шаблон menu ('menu')
* [name] - строка, имя view или или меню menu
* user - строка, логин пользователя
* role - строка, роль искомого объекта прав
* socket - объект сокета
* callback (err, reply) — функция обратного вызова
    * err - ошибка работы с Redis от node_redis, отсутствие прав, ошибки от view
    * html - строка с html кодом
    * congig - объект с конфигами для view сгруппированными по view

## queryToView ( type, request, viewName, socket, callback )
Обрабатывает запросы по работе с данными из view:
* проверяется наличия готового пересечения view прикрепленного к socket в случае их отсутствия:
    * !!! забираем login и role из socket
    * создаем модели прав на view по роли и по пользователю определяем пересечение прав
    * создаем модели прав по роли и по пользователю на flexo схемы входящие во view и находим их пересечения
    * создаем flexo коллекции входящие во view c максимальными параметрами на чтение при их наличии
    * прикрепляем все данные о правах к view и созданные flexo коллекции к socket
* проверяем права на чтение, модификацию, удаление, изменение в зависимости от типа запроса
* в случае успешной проверки передаем необходимых параметров во view

Параметры:
* type - строка тип запроса
* request - объект, запрос пользователя
    * queries - объект, содержит запросы к соответствующим flexo
* viewName - строка, имя view
* socket - объект сокета (временно для нахождения прав необходимо прикрепить login и роль)
* callback (err, reply, count) — функция обратного вызова
     * err — ошибка работы с Redis от node_redis, отсутствие прав, ошибки от view
     * reply —

Пример работы с контроллером представлен в файле: test.js